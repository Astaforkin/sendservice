### Sendservice
Cервис, который по заданным правилам запускает рассылку по списку клиентов.

## Задача
Необходимо разработать сервис управления.

## Описание
Необходимо реализовать методы создания новой рассылки и просмотр
созданных рассылок.

## Критерии приёмки

- Выполненное задание необходимо разместить в публичном репозитории на github;
- Необходимо использовать Docker для запуска приложения;
- Коллекция Postman для проверки API.

### Основное задание

Спроектировать и разработать сервис, который по заданным правилам запускает
рассылку по списку клиентов.

Сущность "рассылка" имеет атрибуты:
- уникальный id рассылки
- дата и время запуска рассылки
- текст сообщения для доставки клиенту
- фильтр свойств клиентов, на которых должна быть произведена рассылка
(код мобильного оператора, тег)
- дата и время окончания рассылки: если по каким-то причинам не успели
разослать все сообщения - никакие сообщения клиентам после этого времени
доставляться не должны

Сущность "клиент" имеет атрибуты:
- уникальный id клиента
- номер телефона клиента в формате 7XXXXXXXXXX (X - цифра от 0 до 9)
- код мобильного оператора
- тег (произвольная метка)

Сущность "сообщение" имеет атрибуты:
- уникальный id сообщения
- дата и время создания (отправки)
- id рассылки, в рамках которой было отправлено сообщение
- id клиента, которому отправили

## Логика рассылки

- После создания новой рассылки, если текущее время больше времени начала и
меньше времени окончания - должны быть выбраны из справочника все клиенты,
которые подходят под значения фильтра, указанного в этой рассылке и запущена
отправка для всех этих клиентов.
- Если создаётся рассылка с временем старта в будущем - отправка должна
стартовать автоматически по наступлению этого времени без дополнительных
действий со стороны пользователя системы.
Сообщения рассылки можно выводить в консоль приложения.



### Технологии:
- Python
- Django
- Django Rest Framework
- Docker
- Celery

### Решение 

Каждую минуту запускается процесс process_mailings, который сканирует базу данных на наличие активных рассылок и клиентов, которые подходят под правила рассылки, затем отправляется сообщение и создаётся объект message, если клиенту по данной рассылке уже было отправленно сообщение - повторное не отправляется.

## Установка и запуск

1. Склонировать репозиторий с Github:

````
git@github.com:Astaforkin/sendservice.git
````
2. Перейти в директорию проекта

3. Создать виртуальное окружение:

````
python -m venv venv
````

4. Активировать окружение: 

````
source venv/bin/activate
````
 
5. Установка зависимостей:

```
pip install -r requirements.txt
```

6. Создать и применить миграции в базу данных:
```
python manage.py makemigrations
python manage.py migrate
```
7. Запустить сервер
```
python manage.py runserver
```
8. Запустить celery
```
celery -A sendservice worker -l info

8. Запустить celery-beat
```
celery -A sendservice beat -l info
```

## Установка проекта с помощью docker-compose


1. Склонировать репозиторий с Github
```
git clone git@github.com:Astaforkin/sendservice.git
```
2. Перейти в директорию проекта
3. Запустить контейнеры 
``` 
sudo docker compose up -d
 ```
4. Остановка работы контейнеров 
```
sudo docker compose stop
```

## Работа с проектом

1. Создать супер пользователя
``` 
docker compose exec sendservice python manage.py createsuperuser
 ```
2. Через админку или с помощью DRF заполнить поля в Mailing, Clients

3. После заполнения полей, если если текущее время больше времени начала и
меньше времени окончания расылки, произойдет автоматичесская отправка сообщений клиентам, чьи параметры отвечают требованиям рассылки.
В консоли можно посмотреть колличество активных рассылок, сколько клиентов отвечает требованиям рассылки, и скольким было отправлено сообщение (при условии что они не получали уже сообщения по данной рассылке).

## Работа с проектом через Postman

1. Пользователя можно создать через API. Придумайте новую пару «логин-пароль» и отправьте POST-запрос на http://127.0.0.1:8000/auth/users/, передав их в полях username и password.

2. Теперь можно получить токен: отправьте POST-запрос на эндпоинт /auth/jwt/create/, передав действующий логин и пароль в полях username и password. 

3. API вернёт JWT-токен в поле access, выбрать соответствующий тип авторизации во вкладке Authorization и указать JWT-токен уже там.

## Автор

[Астафоркин Никита](https://github.com/Astaforkin)
